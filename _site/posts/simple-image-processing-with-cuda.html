<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Simple image processing with CUDA</title>
  <meta name="author" content="Mads Ravn" />
  <meta name="description" content="Mads Ravn - An avid coder and lazy donkey." />
  <link rel="alternate" type="application/rss+xml" href="https://feeds.feedburner.com/madsravn" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab">
  <link rel="stylesheet" href="/css/html5reset.css" media="all">
  <link rel="stylesheet" href="/css/col.css" media="all">
  <link rel="stylesheet" href="/css/2cols.css" media="all">
  <link rel="stylesheet" href="/css/3cols.css" media="all">
  <link rel="stylesheet" href="/css/4cols.css" media="all">
  <link rel="stylesheet" href="/css/5cols.css" media="all">
  <link rel="stylesheet" href="/css/6cols.css" media="all">
  <link rel="stylesheet" href="/css/7cols.css" media="all">
  <link rel="stylesheet" href="/css/8cols.css" media="all">
  <link rel="stylesheet" href="/css/9cols.css" media="all">
  <link rel="stylesheet" href="/css/10cols.css" media="all">
  <link rel="stylesheet" href="/css/11cols.css" media="all">
  <link rel="stylesheet" href="/css/12cols.css" media="all">
  <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection" />
  <link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>
<body>
<div class="section group">
<div class="col span_1_of_10">
  <div class="middle">
    <a href="/">
      <img src="https://1.gravatar.com/avatar/cff6826c1faad4528b1ce15dda1f0e6d" height="75" width="75" class="avatar" />
    </a>

    <section class="name">
      <a href="/">
        <span class="ravn">Mads</span>
        <span class="ravn">Ravn</span>
      </a>
    </section>

    <section class="meta">
    <a href="https://github.com/madsravn"><img src="https://madsravn.dk/images/github.png" height="20" width=20" alt="Github"/></a>
    <a href="https://twitter.com/ravnmads"><img src="https://madsravn.dk/images/twitter.png" height="20" width="20" alt="twitter"/></a>
    <a href="https://feeds.feedburner.com/madsravn"><img src="https://madsravn.dk/images/rss.png" height="20" width="20" alt="feed"/> </a>
    </section>
    <br />

    <section class="menu">
      <a href="index.html">
        <p class="menubig">
          01
        </p>
        <p class="menusmall">
          blog
        </p>
      </a>
      <hr />
      <a href="projects.html">
        <p class="menubig">
          02
        </p>
        <p class="menusmall">
          projects
        </p>
      </a>
      <hr />
      <a href="about.html">
        <p class="menubig">
          03
        </p>
        <p class="menusmall">
          about
        </p>
      </a>
    </section>
  </div>
</div>
<div class="col span_9_of_10">

  <section class="content">
  <h1>
    <a href="/posts/simple-image-processing-with-cuda">Simple image processing with CUDA</a>
  </h1>

  <section class="byline">
    October 27, 2013
  </section>

  <p>I like graphics and image processing. So I have been fiddling a little with NVIDIAs CUDA in order to capatilize on some multithreaded programming. I have made a little starter edition for people who wants to try forces with CUDA for image processing.</p>

<p>I am using <a href="https://lodev.org/lodepng/">lodepng</a> for loading and saving images for the filtering. It is very easy to easy, has no dependencies and just works. In my example code I am reading filenames for input and output images from the command line parameters.</p>

<p>Enough talk, let’s see some code:</p>

<p>In my <code class="language-plaintext highlighter-rouge">main.cpp</code> file I load and save images and call the filter.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int main(int argc, char** argv) {
    if(argc != 3) {
        std::cout &lt;&lt; "Run with input and output image filenames." &lt;&lt; std::endl;
        return 0;
    }

    // Read the arguments
    const char* input_file = argv[1];
    const char* output_file = argv[2];

    std::vector&lt;unsigned char&gt; in_image;
    unsigned int width, height;

    // Load the data
    unsigned error = lodepng::decode(in_image, width, height, input_file);
    if(error) std::cout &lt;&lt; "decoder error " &lt;&lt; error &lt;&lt; ": " &lt;&lt; lodepng_error_text(error) &lt;&lt; std::endl;

    // Prepare the data
    unsigned char* input_image = new unsigned char[(in_image.size()*3)/4];
    unsigned char* output_image = new unsigned char[(in_image.size()*3)/4];
    int where = 0;
    for(int i = 0; i &lt; in_image.size(); ++i) {
       if((i+1) % 4 != 0) {
           input_image[where] = in_image.at(i);
           output_image[where] = 255;
           where++;
       }
    }

    // Run the filter on it
    filter(input_image, output_image, width, height); 

    // Prepare data for output
    std::vector&lt;unsigned char&gt; out_image;
    for(int i = 0; i &lt; in_image.size(); ++i) {
        out_image.push_back(output_image[i]);
        if((i+1) % 3 == 0) {
            out_image.push_back(255);
        }
    }
    
    // Output the data
    error = lodepng::encode(output_file, out_image, width, height);

    //if there's an error, display it
    if(error) std::cout &lt;&lt; "encoder error " &lt;&lt; error &lt;&lt; ": "&lt;&lt; lodepng_error_text(error) &lt;&lt; std::endl;

    delete[] input_image;
    delete[] output_image;
    return 0;

}
</code></pre></div></div>

<p>We notice how easy lodepng is to use. We tell it we want our image loaded into our vector and voila, we have it. We then remove the alpha channel, as I was not using it in my project. You can however change it to your preferences. We then give our image data to the <code class="language-plaintext highlighter-rouge">filter</code> function - this is the function which will load the data onto our GPU and call the CUDA kernel which runs our filter. We then save our image, clean up and exits.</p>

<p>Now let’s look at some actual CUDA stuff. The code below resides in <code class="language-plaintext highlighter-rouge">kernels.cu</code>. The CUDA compiler, nvcc, is sort of picky as to what filename extensions it will compile as what. For now, just let the name be.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> void filter (unsigned char* input_image, unsigned char* output_image, int width, int height) {

    unsigned char* dev_input;
    unsigned char* dev_output;
    getError(cudaMalloc( (void**) &amp;dev_input, width*height*3*sizeof(unsigned char)));
    getError(cudaMemcpy( dev_input, input_image, width*height*3*sizeof(unsigned char), cudaMemcpyHostToDevice ));
 
    getError(cudaMalloc( (void**) &amp;dev_output, width*height*3*sizeof(unsigned char)));

    dim3 blockDims(512,1,1);
    dim3 gridDims((unsigned int) ceil((double)(width*height*3/blockDims.x)), 1, 1 );

    filter&lt;&lt;&lt;gridDims, blockDims&gt;&gt;&gt;(dev_input, dev_output, width, height); 


    getError(cudaMemcpy(output_image, dev_output, width*height*3*sizeof(unsigned char), cudaMemcpyDeviceToHost ));

    getError(cudaFree(dev_input));
    getError(cudaFree(dev_output));

}
</code></pre></div></div>

<p>We allocate and copy our data to the GPU. We need the data on the GPU for the kernels to be able to read it. We also allocate storage for the output image, so we have a place to write the result of the filter to. The «&lt;»&gt; is CUDA syntax and will be interpreted when compiled. It tells the compiler how many blocks and grids we are going to use. Mostly every CUDA function an enum <code class="language-plaintext highlighter-rouge">cudaError_t</code> which is why every CUDA call is surrounded by <code class="language-plaintext highlighter-rouge">getError</code>. This way we get an error printed to the screen if anything goes wrong. Don’t worry too much about it, you can see the code for it in <code class="language-plaintext highlighter-rouge">helpers.cpp</code>.</p>

<p>Now, let’s look at the actual filter, also located in <code class="language-plaintext highlighter-rouge">kernels.cu</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>__global__
void blur(unsigned char* input_image, unsigned char* output_image, int width, int height) {

    const unsigned int offset = blockIdx.x*blockDim.x + threadIdx.x;
    int x = offset % width;
    int y = (offset-x)/width;
    int fsize = 5; // Filter size
    if(offset &lt; width*height) {

        float output_red = 0;
        float output_green = 0;
        float output_blue = 0;
        int hits = 0;
        for(int ox = -fsize; ox &lt; fsize+1; ++ox) {
            for(int oy = -fsize; oy &lt; fsize+1; ++oy) {
                if((x+ox) &gt; -1 &amp;&amp; (x+ox) &lt; width &amp;&amp; (y+oy) &gt; -1 &amp;&amp; (y+oy) &lt; height) {
                    const int currentoffset = (offset+ox+oy*width)*3;
                    output_red += input_image[currentoffset]; 
                    output_green += input_image[currentoffset+1];
                    output_blue += input_image[currentoffset+2];
                    hits++;
                }
            }
        }
        output_image[offset*3] = output_red/hits;
        output_image[offset*3+1] = output_green/hits;
        output_image[offset*3+2] = output_blue/hits;
        }
}
</code></pre></div></div>

<p>Again, the <strong>global</strong> is a CUDA keyword. For each pixel in the input image we take the average of each of the neighbouring pixels and writes it to the output image. This filter is known as a Box blur. A better blur filter would be the Gaussian blur. I have written a Gaussian function in <code class="language-plaintext highlighter-rouge">helpers.cpp</code> if you want to try. However, before doing that, just try to play around it and see what happens. I learn best from trial and error, and that is also why graphics and image processing is a subject I like - because you can see the result of your work in an easily understanded way instead of reading thousands of lines of output data.</p>

<p>Notice that we check if our <code class="language-plaintext highlighter-rouge">offset</code> is actually within the range of <code class="language-plaintext highlighter-rouge">width*height</code> because it can happen that it will be outside due to the blocks CUDA will run, so remember to keep that. Also we need to remember to check whether or not the pixel we read are actually in our image when doing the box blur as well. You can try to remove them one at a time and see what happens.</p>

<p>So now, try running the program on an image and look at the output image. Blurred, huh?</p>

<p>I have made a simple compile script for the project as well - it works for linux and MAC OSX. Under Windows I guess it’s pretty easy to get it up and running in Visual Studio as well. Good luck. <a href="https://github.com/madsravn/easyCuda"> The code can be found on my github</a>.</p>


  <section class="meta">
    <h3>Discussion, links, and tweets</h3>
    <section class="copy">
      <a href="https://twitter.com/madsravn">
        <img src="https://1.gravatar.com/avatar/cff6826c1faad4528b1ce15dda1f0e6d" height="50" width="50" />
      </a>

      <p>
        I'm a developer and CS graduate. <a href="https://twitter.com/madsravn">Follow me on Twitter</a>;
        you'll enjoy my tweets.
      </p>

      
      <p>
        You can discuss, upvote, downvote, and poke fun of this post over at <a href="https://news.ycombinator.com/item?id=6622979">Hacker News</a>.
      </p>
      
      
      
      <p>
        You can discuss, upvote, downvote, and poke fun of this post over at <a href="https://www.reddit.com/r/programming/comments/1pbuyt/simple_image_processing_with_cuda/">Reddit</a>.
      </p>
      

      <p>
        I also keep an "ask me anything" type of project in a repository on GitHub (naturally!). Feel free to <a href="https://github.com/madsravn/madsravn.github.com/issues">ask me a question</a>.
      </p>

      <a href="https://twitter.com/share" class="twitter-share-button" data-count="none" data-via="ravnmads">Tweet</a>
      <a href="https://twitter.com/ravnmads" class="twitter-follow-button" data-show-count="false">Follow @ravnmads</a>
      <script src="https://platform.twitter.com/widgets.js" type="text/javascript"></script>
    </section>
  </section>
</section>


  <br />

  <ul>
  
    <li>
      <h2><a href="/posts/contributing-to-clang">Contributing to Clang</a></h2>
      <p>A year or so ago I started contributing code to Clang. For those of you who doesn’t know what <a href="https://clang.llvm.org/">Clang</a> is; it is a C and C++ front-end for LLVM. In short, a C++ compiler. I have mostly been doing work on <a href="https://clang.llvm.org/extra/clang-tidy/">Clang-Tidy</a> which is a Clang-based C++ linter. It can help you find errors, enforce coding guidelines or modernize your project. it is a very helpful tool which can be an effective part of your tool chain. It is also very easy to extend Clang-Tidy with your own checks - and it also easy to have this code accepted into the official Clang project.</p>

    </li>
  
    <li>
      <h2><a href="/posts/meeting-cpp-trip-report">Meeting C++ trip report</a></h2>
      <p>Last week I attended my first ever C++ conference. It was the Meeting C++ conference in Berlin. The conference was very nicely planned with some good speakers and good topics. There were only a few minor details which was inconvinient. Below I will try to express some thoughts about the different talks I saw and about the conference in general.</p>

    </li>
  
    <li>
      <h2><a href="/posts/master-thesis-done-lessons-learned">Master thesis done - lessons learned</a></h2>
      <p>I graduated from Aarhus University with a degree in Computer Science this june. Now, I’m finally getting around to publishing my code (as I linked in my thesis). I thought that I would give a quick summary of the process of writing my thesis as well. You can find my thesis and the code I developed for my thesis <a href="./../../BIS/index.html">here</a>. The title of my thesis is Orthogonal Range Searching in 2D with Ball Inheritance and my advisor was <a href="https://cs.au.dk/~larsen/">Kasper Green Larsen</a>.</p>

    </li>
  
    <li>
      <h2><a href="/posts/what-is-better-xbox-or-playstation">What is better - Xbox One or Playstation 4?</a></h2>
      <p>With the two new consoles being released soon, there is a lot of hype about it online. There is a lot of articles online describing the differences in performance, games, design and usability - reading the comparisons of the consoles almost seems like a bigger time consumption than actually playing on the console.</p>

    </li>
  
    <li>
      <h2><a href="/posts/simple-image-processing-with-cuda">Simple image processing with CUDA</a></h2>
      <p>I like graphics and image processing. So I have been fiddling a little with NVIDIAs CUDA in order to capatilize on some multithreaded programming. I have made a little starter edition for people who wants to try forces with CUDA for image processing.</p>

    </li>
  
    <li>
      <h2><a href="/posts/final-handin-for-rendalg">Improving performance with packet tracing and other methods</a></h2>
      <h2 id="introduction">Introduction</h2>

    </li>
  
    <li>
      <h2><a href="/posts/chess-summary-for-january">Chess summary for January</a></h2>
      <h2 id="introduction">Introduction</h2>

    </li>
  
    <li>
      <h2><a href="/posts/raspberry-with-slow-external-hard-drive">Raspberry Pi with slow external hard drive</a></h2>
      <p>On a day like January 1st I mostly like relaxing in front of the TV with some movies or series and I had been looking forward to it. I got a powered USB hub for Christmas since our external hard drive, a Verbatim N446, is USB powered and the Raspberry doesn’t provide enough power for it. So we plugged in our new USB hub and plugged the drive to that. Discovery and mounting went fine, but when we started watching something it would take 3 seconds before it would start to buffer - it actually used more time buffered than playing.</p>

    </li>
  
    <li>
      <h2><a href="/posts/music-or-audiobooks-or">Music or audiobooks or ...</a></h2>
      <p>Many people today listen to music on the go - to work, to school or just between places.  When I look around on any given day most people either have ear plugs in their ears or headphones over them.  Some people actually play so loud that you can just behind them and enjoy their music for free, while others I look at and wonder what they’re playing.</p>

    </li>
  
    <li>
      <h2><a href="/posts/first-post">First post with Jekyll</a></h2>
      <p><b>First post with jekyll:</b> This is my first post with the jekyll engine. While I have yet to understand all the wonders of it, I find it most awesome.
You can find more information about the jekyll engine on Github <a href="https://github.com/mojombo/jekyll">here</a>. I am also using <a href="https://daringfireball.net/projects/markdown/syntax">this short overview</a> to learn the markdown syntax used by Github to render the pages on github pages.</p>

    </li>
  
</ul>
</div>

</body>

</html>
